generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                 String              @id @default(uuid())
  email              String              @unique
  passwordHash       String
  name               String
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  preferences        Json?
  fullGodEnd         DateTime?
  fullGodStart       DateTime?
  lastGodmodeScanAt  DateTime?
  crmType            String?
  crmEmails          Json?
  autonomousActions  AutonomousAction[]
  crmIntegrations    CRMIntegration[]
  calendarAccounts   CalendarAccount[]
  chatConversations  ChatConversation[]
  commissionFormulas CommissionFormula[]
  contacts           Contact[]
  crmSyncHistory     CrmSyncLedger[]
  deals              Deal[]
  emailAccounts      EmailAccount[]
  exports            Export[]
  nurtureSequences   NurtureSequence[]
  properties         Property[]
  pushSubscriptions  PushSubscription[]
  tasks              Task[]
  threads            Thread[]
  timelineEvents     TimelineEvent[]
  voiceNotes         VoiceNote[]
  zenaActions        ZenaAction[]

  @@index([email])
}

model EmailAccount {
  id           String    @id @default(uuid())
  userId       String
  provider     String
  email        String
  accessToken  String
  refreshToken String
  tokenExpiry  DateTime
  lastSyncAt   DateTime?
  syncEnabled  Boolean   @default(true)
  createdAt    DateTime  @default(now())
  user         User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  threads      Thread[]

  @@index([userId])
  @@index([email])
}

model CalendarAccount {
  id           String    @id @default(uuid())
  userId       String
  provider     String
  email        String
  accessToken  String
  refreshToken String
  tokenExpiry  DateTime
  lastSyncAt   DateTime?
  syncEnabled  Boolean   @default(true)
  createdAt    DateTime  @default(now())
  user         User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([email])
}

model Thread {
  id              String       @id @default(uuid())
  userId          String
  emailAccountId  String
  externalId      String
  subject         String
  participants    Json
  classification  String
  category        String
  propertyId      String?
  dealId          String?
  stage           String?
  riskLevel       String       @default("none")
  riskReason      String?
  nextAction      String?
  nextActionOwner String
  lastMessageAt   DateTime
  lastReplyAt     DateTime?
  summary         String
  draftResponse   String?
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  messages        Message[]
  deal            Deal?        @relation(fields: [dealId], references: [id])
  emailAccount    EmailAccount @relation(fields: [emailAccountId], references: [id], onDelete: Cascade)
  property        Property?    @relation(fields: [propertyId], references: [id])
  user            User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([emailAccountId])
  @@index([propertyId])
  @@index([dealId])
  @@index([category])
  @@index([classification])
  @@index([riskLevel])
  @@index([lastMessageAt])
}

model Message {
  id         String   @id @default(uuid())
  threadId   String
  externalId String
  from       Json
  to         Json[]
  cc         Json[]
  subject    String
  body       String
  bodyHtml   String?
  sentAt     DateTime
  receivedAt DateTime
  isFromUser Boolean  @default(false)
  createdAt  DateTime @default(now())
  thread     Thread   @relation(fields: [threadId], references: [id], onDelete: Cascade)

  @@unique([threadId, externalId])
  @@index([threadId])
  @@index([sentAt])
}

model Contact {
  id                  String             @id @default(uuid())
  userId              String
  name                String
  emails              String[]
  phones              String[]
  role                String
  relationshipNotes   Json[]
  createdAt           DateTime           @default(now())
  updatedAt           DateTime           @updatedAt
  intelligenceSnippet String?
  lastActivityAt      DateTime?
  lastActivityDetail  String?
  categorizedAt       DateTime?
  categoryConfidence  Float?
  zenaCategory        ZenaCategory       @default(PULSE)
  zenaIntelligence    Json?
  engagementReasoning String?
  lastCrmExportAt     DateTime?
  autonomousActions   AutonomousAction[]
  user                User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  prediction          ContactPrediction?
  nurtureSequences    NurtureSequence[]
  buyerProperties     Property[]         @relation("BuyerContacts")
  deals               Deal[]             @relation("DealContacts")
  vendorProperties    Property[]         @relation("VendorContacts")
  appointmentParticipants AppointmentParticipant[]

  @@index([userId])
  @@index([emails])
  @@index([role])
}

model Property {
  id                String              @id @default(uuid())
  userId            String
  address           String
  milestones        Json[]
  riskOverview      String?
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  bathrooms         Int?
  bedrooms          Int?
  landSize          String?
  floorSize         String?
  listingPrice      Decimal?            @db.Decimal(12, 2)
  status            String              @default("active")
  type              String              @default("residential")
  inquiryCount      Int                 @default(0)
  listingDate       DateTime?
  inferredFromWeb   Boolean             @default(false)
  rateableValue     Int?
  viewingCount      Int                 @default(0)
  lastCrmExportAt   DateTime?
  autonomousActions AutonomousAction[]
  deals             Deal[]
  user              User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  prediction        PropertyPrediction?
  threads           Thread[]
  buyers            Contact[]           @relation("BuyerContacts")
  vendors           Contact[]           @relation("VendorContacts")

  @@index([userId])
  @@index([address])
}

model Deal {
  id                      String             @id @default(uuid())
  userId                  String
  threadId                String?
  propertyId              String?
  stage                   String
  riskLevel               String             @default("none")
  riskFlags               String[]
  nextAction              String?
  nextActionOwner         String
  summary                 String
  createdAt               DateTime           @default(now())
  updatedAt               DateTime           @updatedAt
  auctionDate             DateTime?
  commissionFormulaId     String?
  conditions              Json?
  conjunctionalAgencyId   String?
  dealValue               Decimal?           @db.Decimal(12, 2)
  estimatedCommission     Decimal?           @db.Decimal(10, 2)
  goLiveDate              DateTime?
  isConjunctional         Boolean            @default(false)
  lastContactAt           DateTime?
  pipelineType            String             @default("buyer")
  saleMethod              String             @default("negotiation")
  settlementDate          DateTime?
  stageEnteredAt          DateTime           @default(now())
  tenderCloseDate         DateTime?
  conjunctionalAgencyName String?
  conjunctionalSplit      Float?
  isListingAgent          Boolean            @default(true)
  status                  String             @default("active")
  commissionFormula       CommissionFormula? @relation(fields: [commissionFormulaId], references: [id])
  property                Property?          @relation(fields: [propertyId], references: [id])
  user                    User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  nurtureSequences        NurtureSequence[]
  threads                 Thread[]
  zenaActions             ZenaAction[]
  contacts                Contact[]          @relation("DealContacts")

  @@index([userId])
  @@index([propertyId])
  @@index([stage])
  @@index([riskLevel])
  @@index([pipelineType])
  @@index([stageEnteredAt])
}

model TimelineEvent {
  id         String   @id @default(uuid())
  userId     String
  type       String
  entityType String
  entityId   String
  summary    String
  content    String?
  metadata   Json?
  timestamp  DateTime
  createdAt  DateTime @default(now())
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  participants AppointmentParticipant[]
  
  @@index([userId])
  @@index([entityType, entityId])
  @@index([timestamp])
}

model AppointmentParticipant {
  id                  String        @id @default(uuid())
  timelineEventId     String
  contactId           String
  role                String        // 'vendor', 'buyer', 'tenant', 'agent'
  status              String        @default("pending") // 'confirmed', 'pending', 'declined'
  communicationChannel String?      // 'sms', 'email'
  
  timelineEvent       TimelineEvent @relation(fields: [timelineEventId], references: [id], onDelete: Cascade)
  contact             Contact       @relation(fields: [contactId], references: [id], onDelete: Cascade)

  @@index([timelineEventId])
  @@index([contactId])
}

model Task {
  id                String    @id @default(uuid())
  userId            String
  label             String
  status            String    @default("open")
  dueDate           DateTime?
  dealId            String?
  propertyId        String?
  contactId         String?
  source            String
  context           String?   // 'drive', 'desk', 'site'
  estimatedDuration Int?      // in minutes
  createdAt         DateTime  @default(now())
  completedAt       DateTime?
  user              User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
  @@index([dueDate])
}

model VoiceNote {
  id                String    @id @default(uuid())
  userId            String
  audioUrl          String
  transcript        String
  extractedEntities Json[]
  processingStatus  String    @default("pending")
  createdAt         DateTime  @default(now())
  processedAt       DateTime?
  user              User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([processingStatus])
}

model CRMIntegration {
  id          String    @id @default(uuid())
  userId      String
  provider    String
  credentials String
  syncEnabled Boolean   @default(true)
  lastSyncAt  DateTime?
  syncConfig  Json
  createdAt   DateTime  @default(now())
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([provider])
}

model Export {
  id          String    @id @default(uuid())
  userId      String
  type        String
  format      String
  fileUrl     String
  recordCount Int
  status      String    @default("pending")
  createdAt   DateTime  @default(now())
  completedAt DateTime?
  content     String?
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
}

model PushSubscription {
  id        String   @id @default(uuid())
  userId    String
  endpoint  String   @unique
  keys      Json
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([endpoint])
}

model NotificationPreferences {
  id                  String   @id @default(uuid())
  userId              String   @unique
  highPriorityThreads Boolean  @default(true)
  riskDeals           Boolean  @default(true)
  calendarReminders   Boolean  @default(true)
  taskReminders       Boolean  @default(true)
  newThreads          Boolean  @default(false)
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  dealDeadlines       Boolean  @default(true)
  morningBriefing     Boolean  @default(true)
  settlementCountdown Boolean  @default(true)
  staleDealAlerts     Boolean  @default(true)

  @@index([userId])
}

model ChatConversation {
  id        String        @id @default(uuid())
  userId    String
  title     String?
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt
  user      User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  messages  ChatMessage[]

  @@index([userId])
}

model ChatMessage {
  id             String           @id @default(uuid())
  conversationId String
  role           String
  content        String
  attachments    Json?
  createdAt      DateTime         @default(now())
  conversation   ChatConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId])
}

model CommissionFormula {
  id        String   @id @default(uuid())
  userId    String
  name      String
  isDefault Boolean  @default(false)
  tiers     Json
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  deals     Deal[]

  @@index([userId])
  @@index([isDefault])
}

model ZenaAction {
  id          String    @id @default(uuid())
  userId      String
  dealId      String
  type        String
  status      String    @default("pending")
  output      String
  triggeredAt DateTime  @default(now())
  executedAt  DateTime?
  dismissedAt DateTime?
  deal        Deal      @relation(fields: [dealId], references: [id], onDelete: Cascade)
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([dealId])
  @@index([status])
  @@index([type])
}

model NurtureSequence {
  id            String    @id @default(uuid())
  userId        String
  dealId        String
  contactId     String
  status        String    @default("active")
  currentStep   Int       @default(1)
  nextTouchDate DateTime
  lastTouchAt   DateTime?
  touchCount    Int       @default(0)
  notes         String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  contact       Contact   @relation(fields: [contactId], references: [id], onDelete: Cascade)
  deal          Deal      @relation(fields: [dealId], references: [id], onDelete: Cascade)
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, status])
  @@index([nextTouchDate])
  @@index([dealId])
}

model ContactPrediction {
  id                    String    @id @default(uuid())
  contactId             String    @unique
  userId                String
  maturityLevel         Int       @default(0)
  emailsAnalyzed        Int       @default(0)
  eventsCount           Int       @default(0)
  oldestDataAt          DateTime?
  personalityType       String?
  personalityConfidence Float?
  detectedMarkers       Json?
  communicationTips     Json?
  sellProbability       Float?
  sellConfidence        Float?
  sellSignals           Json?
  buyProbability        Float?
  buyConfidence         Float?
  buySignals            Json?
  churnRisk             Float?
  lastAnalyzedAt        DateTime  @default(now())
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
  contact               Contact   @relation(fields: [contactId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([maturityLevel])
  @@index([personalityType])
}

model AutonomousAction {
  id                  String    @id @default(uuid())
  userId              String
  contactId           String?
  actionType          String
  priority            Int       @default(5)
  title               String
  description         String?
  draftSubject        String?
  draftBody           String?
  status              String    @default("pending")
  mode                String
  scheduledFor        DateTime?
  createdAt           DateTime  @default(now())
  approvedAt          DateTime?
  executedAt          DateTime?
  dismissedAt         DateTime?
  executionResult     Json?
  errorMessage        String?
  assets              Json?
  contextSummary      String?
  intelligenceSources Json?
  payload             Json?
  propertyId          String?
  reasoning           String?
  script              String?
  contact             Contact?  @relation(fields: [contactId], references: [id])
  property            Property? @relation(fields: [propertyId], references: [id])
  user                User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, status])
  @@index([propertyId])
  @@index([scheduledFor])
  @@index([priority])
  @@index([actionType])
}

model PropertyPrediction {
  id                  String    @id @default(uuid())
  propertyId          String    @unique
  momentumScore       Int       @default(0)
  buyerInterestLevel  String    @default("Medium")
  reasoning           String?
  predictedSaleDate   DateTime?
  marketValueEstimate Decimal?  @db.Decimal(12, 2)
  confidenceScore     Float?
  suggestedActions    Json?
  milestoneForecasts  Json?
  lastAnalyzedAt      DateTime  @default(now())
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt
  property            Property  @relation(fields: [propertyId], references: [id], onDelete: Cascade)

  @@index([propertyId])
  @@index([buyerInterestLevel])
}

model AIUsageLog {
  id           String   @id @default(uuid())
  userId       String?
  source       String
  endpoint     String?
  model        String
  inputTokens  Int
  outputTokens Int?
  durationMs   Int?
  createdAt    DateTime @default(now())

  @@index([userId])
  @@index([source])
  @@index([createdAt])
}

model SiteKnowledge {
  id                String              @id @default(uuid())
  domain            String              @unique
  displayName       String?
  category          String              @default("portal")
  discoveryStatus   String              @default("pending")
  discoveryProgress Int                 @default(0)
  lastDiscoveredAt  DateTime?
  discoveryError    String?
  uiMap             Json?
  screenshotRefs    String[]
  loginUrl          String?
  mainUrl           String?
  requiresAuth      Boolean             @default(true)
  queryCount        Int                 @default(0)
  successRate       Float               @default(0)
  lastUsedAt        DateTime?
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  actionPaths       LearnedActionPath[]

  @@index([domain])
  @@index([discoveryStatus])
  @@index([category])
}

model LearnedActionPath {
  id                String        @id @default(uuid())
  siteKnowledgeId   String
  taskType          String
  taskDescription   String
  intentPattern     String?
  steps             Json
  extractionRules   Json?
  successCount      Int           @default(0)
  failureCount      Int           @default(0)
  averageDuration   Int?
  lastSuccessAt     DateTime?
  lastFailedAt      DateTime?
  version           Int           @default(1)
  isActive          Boolean       @default(true)
  deprecatedAt      DateTime?
  deprecationReason String?
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt
  siteKnowledge     SiteKnowledge @relation(fields: [siteKnowledgeId], references: [id], onDelete: Cascade)

  @@unique([siteKnowledgeId, taskType, version])
  @@index([siteKnowledgeId])
  @@index([taskType])
  @@index([isActive])
}

model CrmSyncLedger {
  id             String   @id @default(uuid())
  userId         String
  entityType     String
  entityId       String
  crmTarget      String
  syncMethod     String
  syncedAt       DateTime @default(now())
  syncStatus     String
  emailMessageId String?
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, entityType])
  @@index([userId, syncedAt])
}

enum ZenaCategory {
  PULSE
  HOT_LEAD
  COLD_NURTURE
  HIGH_INTENT
}
