
> @zena/backend@1.0.0 test
> vitest --run ai-processing.service.test.ts


[1m[46m RUN [49m[22m [36mv4.0.15 [39m[90m/Users/hamishmcgee/Desktop/ZenaAntigravity/packages/backend[39m

[90mstdout[2m | src/services/ai-processing.service.test.ts
[22m[39m[AIProcessingService] Using Gemini for processing: gemini-3-flash-preview

[90mstdout[2m | src/services/ai-processing.service.test.ts[2m > [22m[2mAIProcessingService[2m > [22m[2mThread Classification[2m > [22m[2mshould classify buyer threads using fallback when no API key
[22m[39m[AIProcessingService] Using Gemini for processing: gemini-3-flash-preview

[90mstdout[2m | src/services/ai-processing.service.test.ts[2m > [22m[2mAIProcessingService[2m > [22m[2mThread Classification[2m > [22m[2mshould classify vendor threads using fallback
[22m[39m[AIProcessingService] Using Gemini for processing: gemini-3-flash-preview

[90mstdout[2m | src/services/ai-processing.service.test.ts[2m > [22m[2mAIProcessingService[2m > [22m[2mThread Classification[2m > [22m[2mshould classify noise/marketing threads using fallback
[22m[39m[AIProcessingService] Using Gemini for processing: gemini-3-flash-preview

[90mstdout[2m | src/services/ai-processing.service.test.ts[2m > [22m[2mAIProcessingService[2m > [22m[2mThread Classification[2m > [22m[2mshould classify lawyer/broker threads using fallback
[22m[39m[AIProcessingService] Using Gemini for processing: gemini-3-flash-preview

[90mstdout[2m | src/services/ai-processing.service.test.ts[2m > [22m[2mAIProcessingService[2m > [22m[2mThread Classification[2m > [22m[2mshould classify market contact threads using fallback
[22m[39m[AIProcessingService] Using Gemini for processing: gemini-3-flash-preview

[90mstdout[2m | src/services/ai-processing.service.test.ts[2m > [22m[2mAIProcessingService[2m > [22m[2mThread Classification[2m > [22m[2mshould handle threads with minimal information
[22m[39m[AIProcessingService] Using Gemini for processing: gemini-3-flash-preview

[90mstdout[2m | src/services/ai-processing.service.test.ts[2m > [22m[2mAIProcessingService[2m > [22m[2mThread Classification[2m > [22m[2mshould categorize reply threads as waiting
[22m[39m[AIProcessingService] Using Gemini for processing: gemini-3-flash-preview

[90mstdout[2m | src/services/ai-processing.service.test.ts[2m > [22m[2mAIProcessingService[2m > [22m[2mThread Classification[2m > [22m[2mshould categorize new threads as focus
[22m[39m[AIProcessingService] Using Gemini for processing: gemini-3-flash-preview

[90mstdout[2m | src/services/ai-processing.service.test.ts[2m > [22m[2mAIProcessingService[2m > [22m[2mClassification Validation[2m > [22m[2mshould always return valid classification types
[22m[39m[AIProcessingService] Using Gemini for processing: gemini-3-flash-preview

[90mstdout[2m | src/services/ai-processing.service.test.ts[2m > [22m[2mAIProcessingService[2m > [22m[2mClassification Validation[2m > [22m[2mshould return confidence between 0 and 1
[22m[39m[AIProcessingService] Using Gemini for processing: gemini-3-flash-preview

[90mstdout[2m | src/services/ai-processing.service.test.ts[2m > [22m[2mAIProcessingService[2m > [22m[2mEntity Extraction[2m > [22m[2mshould extract contacts from thread participants
[22m[39m[AIProcessingService] Using Gemini for processing: gemini-3-flash-preview

[90mstdout[2m | src/services/ai-processing.service.test.ts[2m > [22m[2mAIProcessingService[2m > [22m[2mEntity Extraction[2m > [22m[2mshould extract property addresses from thread content
[22m[39m[AIProcessingService] Using Gemini for processing: gemini-3-flash-preview

[90mstderr[2m | src/services/ai-processing.service.test.ts[2m > [22m[2mAIProcessingService[2m > [22m[2mEntity Extraction[2m > [22m[2mshould extract property addresses from thread content
[22m[39mError parsing entity extraction response: SyntaxError: Expected ',' or ']' after array element in JSON at position 550 (line 31 column 6)
    at JSON.parse (<anonymous>)
    at AIProcessingService.parseEntityExtractionResponse [90m(/Users/hamishmcgee/Desktop/ZenaAntigravity/packages/backend/[39msrc/services/ai-processing.service.ts:630:27[90m)[39m
    at AIProcessingService.extractEntities [90m(/Users/hamishmcgee/Desktop/ZenaAntigravity/packages/backend/[39msrc/services/ai-processing.service.ts:543:27[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at [90m/Users/hamishmcgee/Desktop/ZenaAntigravity/packages/backend/[39msrc/services/ai-processing.service.test.ts:236:22
    at file:///Users/hamishmcgee/Desktop/ZenaAntigravity/node_modules/[4m@vitest/runner[24m/dist/index.js:915:20
Error extracting entities: SyntaxError: Expected ',' or ']' after array element in JSON at position 550 (line 31 column 6)
    at JSON.parse (<anonymous>)
    at AIProcessingService.parseEntityExtractionResponse [90m(/Users/hamishmcgee/Desktop/ZenaAntigravity/packages/backend/[39msrc/services/ai-processing.service.ts:630:27[90m)[39m
    at AIProcessingService.extractEntities [90m(/Users/hamishmcgee/Desktop/ZenaAntigravity/packages/backend/[39msrc/services/ai-processing.service.ts:543:27[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at [90m/Users/hamishmcgee/Desktop/ZenaAntigravity/packages/backend/[39msrc/services/ai-processing.service.test.ts:236:22
    at file:///Users/hamishmcgee/Desktop/ZenaAntigravity/node_modules/[4m@vitest/runner[24m/dist/index.js:915:20

[90mstdout[2m | src/services/ai-processing.service.test.ts[2m > [22m[2mAIProcessingService[2m > [22m[2mEntity Extraction[2m > [22m[2mshould extract dates and event types from thread content
[22m[39m[AIProcessingService] Using Gemini for processing: gemini-3-flash-preview

[90mstdout[2m | src/services/ai-processing.service.test.ts[2m > [22m[2mAIProcessingService[2m > [22m[2mEntity Extraction[2m > [22m[2mshould extract actions from thread content
[22m[39m[AIProcessingService] Using Gemini for processing: gemini-3-flash-preview

[90mstdout[2m | src/services/ai-processing.service.test.ts[2m > [22m[2mAIProcessingService[2m > [22m[2mEntity Extraction[2m > [22m[2mshould detect deal stage from thread content
[22m[39m[AIProcessingService] Using Gemini for processing: gemini-3-flash-preview

[90mstdout[2m | src/services/ai-processing.service.test.ts[2m > [22m[2mAIProcessingService[2m > [22m[2mEntity Extraction[2m > [22m[2mshould detect risk signals from thread content
[22m[39m[AIProcessingService] Using Gemini for processing: gemini-3-flash-preview

[90mstdout[2m | src/services/ai-processing.service.test.ts[2m > [22m[2mAIProcessingService[2m > [22m[2mEntity Extraction[2m > [22m[2mshould handle threads with no extractable entities
[22m[39m[AIProcessingService] Using Gemini for processing: gemini-3-flash-preview

[90mstdout[2m | src/services/ai-processing.service.test.ts[2m > [22m[2mAIProcessingService[2m > [22m[2mEntity Extraction[2m > [22m[2mshould validate contact roles
[22m[39m[AIProcessingService] Using Gemini for processing: gemini-3-flash-preview

[90mstdout[2m | src/services/ai-processing.service.test.ts[2m > [22m[2mAIProcessingService[2m > [22m[2mEntity Extraction[2m > [22m[2mshould validate date types
[22m[39m[AIProcessingService] Using Gemini for processing: gemini-3-flash-preview

[90mstderr[2m | src/services/ai-processing.service.test.ts[2m > [22m[2mAIProcessingService[2m > [22m[2mEntity Extraction[2m > [22m[2mshould validate date types
[22m[39mError parsing entity extraction response: SyntaxError: Expected ',' or ']' after array element in JSON at position 159 (line 9 column 6)
    at JSON.parse (<anonymous>)
    at AIProcessingService.parseEntityExtractionResponse [90m(/Users/hamishmcgee/Desktop/ZenaAntigravity/packages/backend/[39msrc/services/ai-processing.service.ts:630:27[90m)[39m
    at AIProcessingService.extractEntities [90m(/Users/hamishmcgee/Desktop/ZenaAntigravity/packages/backend/[39msrc/services/ai-processing.service.ts:543:27[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at [90m/Users/hamishmcgee/Desktop/ZenaAntigravity/packages/backend/[39msrc/services/ai-processing.service.test.ts:382:22
    at file:///Users/hamishmcgee/Desktop/ZenaAntigravity/node_modules/[4m@vitest/runner[24m/dist/index.js:915:20
Error extracting entities: SyntaxError: Expected ',' or ']' after array element in JSON at position 159 (line 9 column 6)
    at JSON.parse (<anonymous>)
    at AIProcessingService.parseEntityExtractionResponse [90m(/Users/hamishmcgee/Desktop/ZenaAntigravity/packages/backend/[39msrc/services/ai-processing.service.ts:630:27[90m)[39m
    at AIProcessingService.extractEntities [90m(/Users/hamishmcgee/Desktop/ZenaAntigravity/packages/backend/[39msrc/services/ai-processing.service.ts:543:27[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at [90m/Users/hamishmcgee/Desktop/ZenaAntigravity/packages/backend/[39msrc/services/ai-processing.service.test.ts:382:22
    at file:///Users/hamishmcgee/Desktop/ZenaAntigravity/node_modules/[4m@vitest/runner[24m/dist/index.js:915:20

[90mstdout[2m | src/services/ai-processing.service.test.ts[2m > [22m[2mAIProcessingService[2m > [22m[2mEntity Extraction[2m > [22m[2mshould validate action owners
[22m[39m[AIProcessingService] Using Gemini for processing: gemini-3-flash-preview

 [31m‚ùØ[39m src/services/ai-processing.service.test.ts [2m([22m[2m20 tests[22m[2m | [22m[31m1 failed[39m[2m)[22m[33m 97255[2mms[22m[39m
       [33m[2m‚úì[22m[39m should classify buyer threads using fallback when no API key [33m 4176[2mms[22m[39m
       [33m[2m‚úì[22m[39m should classify vendor threads using fallback [33m 3663[2mms[22m[39m
       [33m[2m‚úì[22m[39m should classify noise/marketing threads using fallback [33m 3098[2mms[22m[39m
       [33m[2m‚úì[22m[39m should classify lawyer/broker threads using fallback [33m 3734[2mms[22m[39m
       [33m[2m‚úì[22m[39m should classify market contact threads using fallback [33m 5568[2mms[22m[39m
       [33m[2m‚úì[22m[39m should handle threads with minimal information [33m 4401[2mms[22m[39m
[31m       [31m√ó[31m should categorize reply threads as waiting[39m[33m 3368[2mms[22m[39m
       [33m[2m‚úì[22m[39m should categorize new threads as focus [33m 3212[2mms[22m[39m
       [33m[2m‚úì[22m[39m should always return valid classification types [33m 3072[2mms[22m[39m
       [33m[2m‚úì[22m[39m should return confidence between 0 and 1 [33m 4155[2mms[22m[39m
       [33m[2m‚úì[22m[39m should extract contacts from thread participants [33m 4117[2mms[22m[39m
       [33m[2m‚úì[22m[39m should extract property addresses from thread content [33m 5991[2mms[22m[39m
       [33m[2m‚úì[22m[39m should extract dates and event types from thread content [33m 5978[2mms[22m[39m
       [33m[2m‚úì[22m[39m should extract actions from thread content [33m 5544[2mms[22m[39m
       [33m[2m‚úì[22m[39m should detect deal stage from thread content [33m 5741[2mms[22m[39m
       [33m[2m‚úì[22m[39m should detect risk signals from thread content [33m 5543[2mms[22m[39m
       [33m[2m‚úì[22m[39m should handle threads with no extractable entities [33m 5034[2mms[22m[39m
       [33m[2m‚úì[22m[39m should validate contact roles [33m 4873[2mms[22m[39m
       [33m[2m‚úì[22m[39m should validate date types [33m 9623[2mms[22m[39m
       [33m[2m‚úì[22m[39m should validate action owners [33m 6349[2mms[22m[39m

[31m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[39m[1m[41m Failed Tests 1 [49m[22m[31m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[39m

[41m[1m FAIL [22m[49m src/services/ai-processing.service.test.ts[2m > [22mAIProcessingService[2m > [22mThread Classification[2m > [22mshould categorize reply threads as waiting
[31m[1mAssertionError[22m: expected 'focus' to be 'waiting' // Object.is equality[39m

Expected: [32m"waiting"[39m
Received: [31m"focus"[39m

[36m [2m‚ùØ[22m src/services/ai-processing.service.test.ts:[2m142:31[22m[39m
    [90m140| [39m
    [90m141| [39m      [90m// Threads with "Re:" typically indicate waiting for response[39m
    [90m142| [39m      [34mexpect[39m(result[33m.[39mcategory)[33m.[39m[34mtoBe[39m([32m'waiting'[39m)[33m;[39m
    [90m   | [39m                              [31m^[39m
    [90m143| [39m      [34mexpect[39m(result[33m.[39mnextActionOwner)[33m.[39m[34mtoBe[39m([32m'other'[39m)[33m;[39m
    [90m144| [39m    })[33m;[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[1/1]‚éØ[22m[39m


[2m Test Files [22m [1m[31m1 failed[39m[22m[90m (1)[39m
[2m      Tests [22m [1m[31m1 failed[39m[22m[2m | [22m[1m[32m19 passed[39m[22m[90m (20)[39m
[2m   Start at [22m 07:21:08
[2m   Duration [22m 97.52s[2m (transform 53ms, setup 45ms, import 67ms, tests 97.26s, environment 0ms)[22m

npm error Lifecycle script `test` failed with error:
npm error code 1
npm error path /Users/hamishmcgee/Desktop/ZenaAntigravity/packages/backend
npm error workspace @zena/backend@1.0.0
npm error location /Users/hamishmcgee/Desktop/ZenaAntigravity/packages/backend
npm error command failed
npm error command sh -c vitest --run ai-processing.service.test.ts
